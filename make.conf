ifeq ($(ACE_ROOT),)
	ACE_ROOT=$(PWD)
endif

.SILENT:

INCLUDE= 	$(ACE_ROOT)/src/include/

OBJ=		$(ACE_ROOT)/obj
IMG=		$(ACE_ROOT)/img

ASM=    	nasm
ASMFLAGS= 	-w+orphan-labels -f elf 
CC=			gcc
LD=			ld

ARCH= i386

#DEFINES+=  -D __DEBUG__
DEFINES+=   -D __KERNEL_BUILT__
DEBUG_FLAGS= -gdwarf-2 -g3

CFLAGS+=    -Wall -Wno-multichar $(DEFINES) -nostartfiles -ffreestanding -funsigned-char -fno-leading-underscore -c -fno-stack-protector $(DEBUG_FLAGS) $(CUSTOM_FLAG)
#LDFLAGS=    -verbose

%.d:    %.c
	@$(CC) -c -M $< -I$(INCLUDE) $(CFLAGS) >> $@

%.o:    %.c
	@$(CC) -c -M $< -I$(INCLUDE) $(CFLAGS) >> $*.d;	cp $*.d $*.do;\
		sed -e 's/#.*//' -e 's/^[^:]*: *//' -e 's/ *\\$$//' -e '/^$$/ d' -e 's/$$/ :/' < $*.do >> $*.d; \
		rm -f $*.do
	@$(CC) -c $(abspath $<) -o $@ -I$(INCLUDE) -I./include $(CFLAGS)
	
%.d:    %.S
	@echo -n $(dir $<) > $@
	@$(CC) -c -M $(abspath $<) -I$(INCLUDE) -I./include $(ASFLAGS) >> $@

%.d:    %.asm
	@$(ASM) $(DEFINES) -i$(INCLUDE) -M $(abspath $<) -o $(<:.asm=.o) > $@

%.o:    %.asm
	@$(ASM) $(DEFINES) $(ASMFLAGS) -i$(INCLUDE) $(abspath $<) -o $@

